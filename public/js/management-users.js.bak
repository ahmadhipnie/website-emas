/**
 * Management Users - Frontend JavaScript
 * Handle CRUD operations untuk user management
 */

let usersTable;
let isEditMode = false;
let isInitialized = false;
let globalEventsBound = false;

/**
 * Setup global event delegation (only once)
 * Event delegation di document level agar tetap bekerja setelah SPA navigation
 */
function setupGlobalEventDelegation() {
  if (globalEventsBound) {
    console.log('‚ÑπÔ∏è Global events already bound');
    return;
  }
  
  console.log('üåê Setting up global event delegation...');
  
  // Delegated event untuk tombol Add User
  $(document).on('click', '#btnAddUser', function(e) {
    e.preventDefault();
    console.log('üîò Add User button clicked (delegated)');
    // Tunggu sebentar untuk memastikan semua elemen sudah ready
    setTimeout(() => {
      openAddModal();
    }, 50);
  });
  
  // Delegated event untuk form submit
  $(document).on('submit', '#userForm', function(e) {
    console.log('üìù User form submitted (delegated)');
    handleSaveUser(e);
  });
  
  // Delegated event untuk confirm delete
  $(document).on('click', '#btnConfirmDelete', function(e) {
    e.preventDefault();
    console.log('üóëÔ∏è Confirm Delete button clicked (delegated)');
    handleDeleteUser();
  });
  
  // Delegated event untuk Edit button di table
  $(document).on('click', '#usersTable .btn-edit', function(e) {
    e.preventDefault();
    const id = $(this).data('id');
    console.log('‚úèÔ∏è Edit button clicked for user ID:', id);
    // Tunggu sebentar untuk memastikan semua elemen sudah ready
    setTimeout(() => {
      openEditModal(id);
    }, 50);
  });

  // Delegated event untuk Delete button di table
  $(document).on('click', '#usersTable .btn-delete', function(e) {
    e.preventDefault();
    const id = $(this).data('id');
    const name = $(this).data('name');
    console.log('üóëÔ∏è Delete button clicked for user:', name, '(ID:', id + ')');
    // Tunggu sebentar untuk memastikan semua elemen sudah ready
    setTimeout(() => {
      openDeleteModal(id, name);
    }, 50);
  });
  
  // Reset form saat modal ditutup
  $(document).on('hidden.bs.modal', '#userModal', resetForm);
  
  globalEventsBound = true;
  console.log('‚úÖ Global event delegation setup complete');
}

/**
 * Initialize DataTable dan Event Listeners
 */
function initializeManagementUsers() {
  console.log('üîÑ Initializing Management Users...');
  console.log('   - jQuery available:', typeof $ !== 'undefined');
  console.log('   - DataTable available:', typeof $.fn.DataTable !== 'undefined');
  console.log('   - Table element exists:', $('#usersTable').length > 0);
  console.log('   - isInitialized:', isInitialized);
  console.log('   - usersTable exists:', !!usersTable);
  
  // Setup global event delegation (only once)
  setupGlobalEventDelegation();
  
  // Check apakah table element ada
  const tableElement = $('#usersTable');
  if (tableElement.length === 0) {
    console.warn('‚ö†Ô∏è Table #usersTable not found');
    return;
  }
  
  // Check if table element has DataTable initialized
  const isDataTableInitialized = $.fn.DataTable.isDataTable('#usersTable');
  console.log('   - DataTable already on element:', isDataTableInitialized);
  
  // Jika DataTable sudah ada pada element ini, skip
  if (isDataTableInitialized && isInitialized) {
    console.log('‚ÑπÔ∏è Already initialized, skipping...');
    return;
  }
  
  // Destroy existing DataTable jika ada
  if (isDataTableInitialized) {
    console.log('üóëÔ∏è Destroying existing DataTable...');
    try {
      $('#usersTable').DataTable().destroy();
    } catch (e) {
      console.warn('Could not destroy table:', e);
    }
    usersTable = null;
    isInitialized = false;
  }
  
  console.log('üìä Creating new DataTable...');
  
  usersTable = $('#usersTable').DataTable({
    ajax: {
      url: '/api/users',
      dataSrc: 'data',
      error: function(xhr, error, code) {
        console.error('DataTables Ajax Error:', {
          status: xhr.status,
          statusText: xhr.statusText,
          error: error,
          code: code,
          response: xhr.responseText
        });
        alert('Gagal memuat data users: ' + xhr.statusText + '\nCek console untuk detail.');
      }
    },
    columns: [
      { data: 'id_user' },
      { data: 'nama' },
      { data: 'email' },
      { 
        data: 'role',
        render: function(data) {
          const badgeClass = data === 'admin' ? 'bg-danger' : 'bg-primary';
          return `<span class="badge ${badgeClass}">${data}</span>`;
        }
      },
      { 
        data: 'created_at',
        render: function(data) {
          return new Date(data).toLocaleDateString('id-ID', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      },
      { 
        data: 'keterangan',
        render: function(data) {
          return data || '-';
        }
      },
      {
        data: null,
        orderable: false,
        render: function(data, type, row) {
          return `
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-warning btn-edit" data-id="${row.id_user}">
                <i class="ti ti-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger btn-delete" data-id="${row.id_user}" data-name="${row.nama}">
                <i class="ti ti-trash"></i>
              </button>
            </div>
          `;
        }
      }
    ],
    order: [[0, 'desc']],
    pageLength: 10,
    language: {
      url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
    }
  });

  // Log element checks
  console.log('   - btnAddUser exists:', $('#btnAddUser').length > 0);
  console.log('   - userForm exists:', $('#userForm').length > 0);
  console.log('   - btnConfirmDelete exists:', $('#btnConfirmDelete').length > 0);
  
  // Note: Event listeners sekarang menggunakan global delegation di setupGlobalEventDelegation()
  // Tidak perlu attach event listener di sini lagi
  
  isInitialized = true;
  console.log('‚úÖ Management Users initialized successfully');
}

/**
 * Reset isInitialized flag (called when leaving page)
 */
function resetManagementUsers() {
  console.log('üßπ Cleaning up Management Users...');
  
  // Destroy DataTable
  if (usersTable) {
    try {
      usersTable.destroy();
    } catch (e) {
      console.warn('Could not destroy table:', e);
    }
    usersTable = null;
  }
  
  // Note: Tidak perlu remove event listeners karena menggunakan global delegation
  // Global delegation tetap aktif dan akan bekerja untuk element yang di-render ulang
  
  isInitialized = false;
  console.log('‚úÖ Management Users cleaned up');
}

/**
 * Check if current page is management-users and initialize if needed
 */
function checkAndInitialize() {
  const currentPath = window.location.pathname;
  const isManagementUsersPage = currentPath === '/management-users' || currentPath.includes('management-users');
  const tableExists = document.getElementById('usersTable') !== null;
  
  console.log('üîç Checking page:', {
    path: currentPath,
    isManagementUsersPage: isManagementUsersPage,
    tableExists: tableExists,
    isInitialized: isInitialized,
    dataTableExists: tableExists && $.fn.DataTable.isDataTable('#usersTable')
  });
  
  if (isManagementUsersPage && tableExists) {
    // Check if already has DataTable
    const alreadyHasDataTable = $.fn.DataTable.isDataTable('#usersTable');
    
    if (alreadyHasDataTable) {
      console.log('‚ÑπÔ∏è DataTable already initialized, skipping...');
      return;
    }
    
    console.log('‚úÖ Management Users page detected, initializing...');
    // Small delay to ensure DOM is ready
    setTimeout(function() {
      if (typeof $ !== 'undefined') {
        initializeManagementUsers();
      } else {
        console.error('‚ùå jQuery not available');
      }
    }, 100);
  } else if (!isManagementUsersPage && isInitialized) {
    console.log('üö™ Left management users page, cleaning up...');
    resetManagementUsers();
  }
}

// Debounce helper
let checkTimeout;
function debouncedCheck() {
  clearTimeout(checkTimeout);
  checkTimeout = setTimeout(checkAndInitialize, 200);
}

// Listen to URL changes (for SPA navigation)
let lastUrl = location.href;
new MutationObserver(() => {
  const url = location.href;
  if (url !== lastUrl) {
    lastUrl = url;
    console.log('üîÑ URL changed to:', url);
    debouncedCheck();
  }
}).observe(document, { subtree: true, childList: true });

// Listen to SPA page loaded event (more reliable than MutationObserver)
document.addEventListener('spa:pageLoaded', function(e) {
  console.log('üöÄ SPA page loaded event received:', e.detail.path);
  // Add delay to ensure all elements are rendered
  setTimeout(checkAndInitialize, 300);
});

// Also check on initial page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', checkAndInitialize);
} else {
  checkAndInitialize();
}

// Expose globally for manual trigger
window.initManagementUsers = initializeManagementUsers;
window.checkManagementUsers = checkAndInitialize;



/**
 * Open modal untuk tambah user baru
 */
function openAddModal() {
  console.log('‚ûï Attempting to open add modal...');
  console.log('   - Current URL:', window.location.pathname);
  console.log('   - userModal exists:', $('#userModal').length > 0);
  console.log('   - usersTable exists:', $('#usersTable').length > 0);
  
  // Pastikan elemen ada
  if ($('#userModal').length === 0) {
    console.warn('‚ö†Ô∏è Modal not found, cannot open add modal');
    console.warn('‚ö†Ô∏è Likely not on management-users page yet');
    return;
  }
  
  // Reset form terlebih dahulu (ini juga akan clear userId dan set isEditMode = false)
  resetForm();
  
  console.log('‚ûï Opening add modal');
  console.log('‚ûï userId after reset:', $('#userId').val(), 'isEmpty:', !$('#userId').val());
  
  $('#userModalLabel').text('Tambah User Baru');
  $('#passwordRequired').show();
  $('#userPassword').prop('required', true);
  $('#userPassword').attr('minlength', '6'); // Add minlength for create
  $('#passwordHelp').show();
  $('#editPasswordHelp').hide();
  
  const modal = new bootstrap.Modal(document.getElementById('userModal'));
  modal.show();
}

/**
 * Open modal untuk edit user
 */
async function openEditModal(userId) {
  // Pastikan elemen ada
  if ($('#userModal').length === 0) {
    console.warn('‚ö†Ô∏è Modal not found, cannot open edit modal');
    return;
  }
  
  // Reset form terlebih dahulu
  resetForm();
  
  console.log('üìù Opening edit modal for user ID:', userId);
  
  try {
    const response = await fetch(`/api/users/${userId}`);
    const result = await response.json();

    if (result.success) {
      const user = result.data;
      
      // Set user ID - ini menentukan mode edit
      $('#userId').val(user.id_user);
      console.log('üìù Set userId to:', user.id_user, 'Type:', typeof user.id_user);
      
      // Fill form dengan data user
      $('#userName').val(user.nama);
      $('#userEmail').val(user.email);
      $('#userRole').val(user.role);
      $('#userKeterangan').val(user.keterangan || '');
      
      // Update modal untuk mode edit
      $('#userModalLabel').text('Edit User');
      $('#passwordRequired').hide();
      $('#userPassword').prop('required', false);
      $('#userPassword').removeAttr('minlength'); // Remove minlength for edit
      $('#passwordHelp').hide();
      $('#editPasswordHelp').show();
      
      // Set isEditMode untuk backward compatibility
      isEditMode = true;
      
      const modal = new bootstrap.Modal(document.getElementById('userModal'));
      modal.show();
    } else {
      showAlert('danger', result.message);
    }
  } catch (error) {
    console.error('Error loading user:', error);
    showAlert('danger', 'Gagal memuat data user');
  }
}

/**
 * Handle save user (create atau update)
 */
async function handleSaveUser(e) {
  e.preventDefault();

  const submitButton = $('#btnSaveUser');
  const saveButtonText = $('#saveButtonText');
  const saveSpinner = $('#saveSpinner');

  // Determine if edit mode based on userId value (more reliable than variable)
  const userId = $('#userId').val();
  const currentIsEditMode = userId && userId.trim() !== '';
  
  console.log('üíæ Saving user...', {
    userId: userId,
    isEditMode: currentIsEditMode
  });

  // Get form data
  const formData = {
    nama: $('#userName').val().trim(),
    email: $('#userEmail').val().trim(),
    role: $('#userRole').val(),
    keterangan: $('#userKeterangan').val().trim()
  };

  // Validasi password
  const password = $('#userPassword').val();
  if (password && password.trim() !== '') {
    // Validasi minimal 6 karakter
    if (password.length < 6) {
      showAlert('danger', 'Password minimal 6 karakter');
      return;
    }
    formData.password = password;
  } else if (!currentIsEditMode) {
    // Password wajib untuk create user baru
    showAlert('danger', 'Password harus diisi untuk user baru');
    return;
  }

  // Disable button dan show loading
  submitButton.prop('disabled', true);
  saveButtonText.text('Menyimpan...');
  saveSpinner.show();

  try {
    let response;
    
    if (currentIsEditMode) {
      // Update user
      console.log('üìù Updating user ID:', userId);
      response = await fetch(`/api/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
    } else {
      // Create user baru
      console.log('‚ûï Creating new user');
      response = await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
    }

    const result = await response.json();

    if (result.success) {
      showAlert('success', result.message);
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
      modal.hide();
      
      // Reload table
      usersTable.ajax.reload();
    } else {
      showAlert('danger', result.message);
    }
  } catch (error) {
    console.error('Error saving user:', error);
    showAlert('danger', 'Terjadi kesalahan saat menyimpan data');
  } finally {
    // Enable button kembali
    submitButton.prop('disabled', false);
    saveButtonText.text('Simpan');
    saveSpinner.hide();
  }
}

/**
 * Open delete confirmation modal
 */
function openDeleteModal(userId, userName) {
  // Pastikan elemen ada
  if ($('#deleteModal').length === 0) {
    console.warn('‚ö†Ô∏è Delete modal not found');
    return;
  }
  
  $('#deleteUserId').val(userId);
  $('#deleteUserName').text(userName);
  
  const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
  modal.show();
}

/**
 * Handle delete user
 */
async function handleDeleteUser() {
  const deleteButton = $('#btnConfirmDelete');
  const deleteButtonText = $('#deleteButtonText');
  const deleteSpinner = $('#deleteSpinner');
  const userId = $('#deleteUserId').val();

  // Disable button dan show loading
  deleteButton.prop('disabled', true);
  deleteButtonText.text('Menghapus...');
  deleteSpinner.show();

  try {
    const response = await fetch(`/api/users/${userId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });

    const result = await response.json();

    if (result.success) {
      showAlert('success', result.message);
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
      modal.hide();
      
      // Reload table
      usersTable.ajax.reload();
    } else {
      showAlert('danger', result.message);
    }
  } catch (error) {
    console.error('Error deleting user:', error);
    showAlert('danger', 'Terjadi kesalahan saat menghapus data');
  } finally {
    // Enable button kembali
    deleteButton.prop('disabled', false);
    deleteButtonText.text('Hapus');
    deleteSpinner.hide();
  }
}

/**
 * Reset form
 */
function resetForm() {
  const form = $('#userForm');
  if (form.length > 0 && form[0]) {
    form[0].reset();
  }
  $('#userId').val('');
  isEditMode = false;
}

/**
 * Show alert message
 */
function showAlert(type, message) {
  const alertDiv = $('#alertMessage');
  const alertText = $('#alertText');

  // Pastikan elemen ada
  if (alertDiv.length === 0) {
    console.log('Alert:', type, message);
    return;
  }

  alertDiv.removeClass().addClass(`alert alert-${type} alert-dismissible fade show`);
  alertText.text(message);
  alertDiv.show();

  // Auto hide after 5 seconds
  setTimeout(() => {
    alertDiv.fadeOut();
  }, 5000);

  // Scroll to top
  $('html, body').animate({ scrollTop: 0 }, 'fast');
}
